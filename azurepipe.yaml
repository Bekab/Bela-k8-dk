trigger:
  branches:
    include:
      - main

pool:
  name: abela-k8-dk

variables:
  terraformVersion: '1.6.6'

stages:
  - stage: DeployTerraform
    jobs:
      - job: InstallAndRunTerraform
        steps:

          - powershell: |
              $terraformZip = "terraform.zip"
              $url = "https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_windows_amd64.zip"
              Invoke-WebRequest -Uri $url -OutFile $terraformZip
              Expand-Archive -Path $terraformZip -DestinationPath .
              Move-Item -Path .\terraform.exe -Destination "C:\Windows\System32\" -Force
              Remove-Item $terraformZip
              terraform -version
            displayName: 'Install Terraform'

          - task: AzureCLI@2
            displayName: 'Terraform Init, Plan, Apply'
            inputs:
              azureSubscription: 'k8-dk'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd IAC
                terraform init
                terraform plan -out=tfplan
                terraform apply -auto-approve tfplan
